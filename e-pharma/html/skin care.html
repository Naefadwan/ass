<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skincare Products - E-Pharma</title>
    <link rel="stylesheet" href="../css/exiisting.css">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/product-cards.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../JS/cart.js"></script>
    
    <script src="../JS/header-fix.js"></script>
    <script src="../JS/user-auth-final.js"></script>
    <script src="../JS/navbar-role-control.js"></script>
    <script src="../JS/config.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <a href="home2.html">
                    <div class="logo-icon">
                        <svg viewBox="0 0 100 100" width="40" height="40">
                            <circle cx="50" cy="50" r="48" fill="#1a73e8"></circle>
                            <circle cx="50" cy="50" r="38" fill="white"></circle>
                            <rect x="47" y="20" width="6" height="60" rx="2" fill="#1a73e8"></rect>
                            <rect x="20" y="47" width="60" height="6" rx="2" fill="#1a73e8"></rect>
                        </svg>
                    </div>
                    <h1>E-Pharma</h1>
                </a>
            </div>
            
            <nav>
                <ul>
                    <li><a href="home2.html">Home</a></li>
                    <li><a href="existingmed.html">Medicines</a></li>
                    <li><a href="skin care.html" class="active">Skincare</a></li>
                    <li><a href="location.html">Locations</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            
            <div class="auth-buttons">
                <a href="login.html" class="btn btn-outline">Login</a>
                <a href="register.html" class="btn btn-primary">Sign Up</a>
            </div>
            
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <section class="page-header">
        <div class="container">
            <h2>Skincare Products Catalog</h2>
            <p>Browse our premium selection of skincare products for healthy, radiant skin</p>
        </div>
    </section>

    <section class="medicines-section">
        <div class="container">
            <div class="filters">
                <div class="search-box">
                    <input type="text" id="skincare-search" placeholder="Search skincare products...">
                    <button><i class="fas fa-search"></i></button>
                </div>
                
                <div class="filter-options">
                    <select id="category-filter">
                        <option value="">All Categories</option>
                        <option value="Cleanser">Cleansers</option>
                        <option value="Moisturizer">Moisturizers</option>
                        <option value="Serum">Serums</option>
                        <option value="Exfoliator">Exfoliators</option>
                        <option value="Mask">Masks</option>
                    </select>
                    
                    <select id="sort-by">
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="price-asc">Price (Low to High)</option>
                        <option value="price-desc">Price (High to Low)</option>
                    </select>
                    
                    <div class="stock-filter">
                        <input type="checkbox" id="in-stock-only" name="stock-filter">
                        <label for="in-stock-only">In Stock Only</label>
                    </div>
                </div>
            </div>
            
            <div class="medicine-grid" id="skincare-grid">
                <!-- Skincare product cards will be dynamically inserted here -->
            </div>
            
            <div class="pagination">
                <button id="prev-page" class="btn btn-outline" disabled>Previous</button>
                <span id="current-page">Page 1</span>
                <button id="next-page" class="btn btn-outline">Next</button>
            </div>
            
            <div id="loading" class="loading-indicator">
                <div class="spinner"></div>
                <p>Loading skincare products...</p>
            </div>
            
            <div id="no-results" class="no-results" style="display: none;">
                <i class="fas fa-search"></i>
                <p>No skincare products found matching your search.</p>
            </div>
        </div>
    </section>
  
    <div class="cart-popup" id="cart-popup">
        <div class="cart-header">
            <h3>Your Cart</h3>
            <button id="close-cart"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="cart-items" id="cart-items">
            <!-- Cart items will be dynamically inserted here -->
        </div>
        
        <div class="cart-footer">
            <div class="cart-total">
                <span>Total:</span>
                <span id="cart-total-amount">$0.00</span>
            </div>
            <button class="btn btn-primary btn-block">Checkout</button>
        </div>
    </div>

    <div class="cart-button" id="cart-button">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-count">0</span>
    </div>

    <footer>
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="home2.html">Home</a></li>
                        <li><a href="existingmed.html">Medicines</a></li>
                        <li><a href="skin care.html">Skincare</a></li>
                        <li><a href="location.html">Locations</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                
                <div class="footer-col">
                    <h3>Customer Support</h3>
                    <ul>
                        <li><a href="help-center.html">Help Center</a></li>
                        <li><a href="contact.html">Contact Us</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="shipping-returns.html">Shipping & Returns</a></li>
                    </ul>
                </div>
                
                <div class="footer-col">
                    <h3>Legal</h3>
                    <ul>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="ToS.html">Terms of Service</a></li>
                        <li><a href="Compliance.html">Compliance</a></li>
                        <li><a href="Accessibility.html">Accessibility</a></li>
                    </ul>
                </div>
                
                <div class="footer-col">
                    <h3>Connect With Us</h3>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                    <p>Email: support@epharma.com</p>
                    <p>Phone: +962 12 345 6789</p>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 E-Pharma. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../JS/config.js"></script>
    <script src="../JS/cart.js"></script>
    <script src="../JS/products.js"></script>
    <script src="../JS/header-fix.js"></script>
    
    <script>
    // Sample skincare products for fallback
    const sampleProducts = [
        {
            id: 'skc-001',
            name: 'Glycolic Acid Toning Solution',
            price: 19.99,
            category: 'Exfoliator',
            description: 'A gentle exfoliating toner for smoother, brighter skin.',
            stock: 15
        },
        {
            id: 'skc-002',
            name: 'Hyaluronic Acid Serum',
            price: 24.99,
            category: 'Serum',
            description: 'Intense hydration for all skin types.',
            stock: 20
        },
        {
            id: 'skc-003',
            name: 'Vitamin C Brightening Cream',
            price: 29.99,
            category: 'Moisturizer',
            description: 'Brightens and evens skin tone while hydrating.',
            stock: 8
        },
        {
            id: 'skc-004',
            name: 'Niacinamide 10% + Zinc 1%',
            price: 18.99,
            category: 'Serum',
            description: 'Helps reduce the appearance of skin blemishes and congestion.',
            stock: 12
        },
        {
            id: 'skc-005',
            name: 'Gentle Facial Cleanser',
            price: 14.99,
            category: 'Cleanser',
            description: 'Removes makeup and impurities without stripping the skin.',
            stock: 25
        },
        {
            id: 'skc-006',
            name: 'Clay Face Mask',
            price: 16.99,
            category: 'Mask',
            description: 'Deep cleansing mask that draws out impurities.',
            stock: 10
        }
    ];

    // Global variables for pagination
    let currentProducts = [];
    let currentPage = 1;
    const productsPerPage = 6;
    let filteredProducts = [];

    // Function to create a product card
    function createProductCard(product) {
        const inStock = product.stock > 0;
        const stockClass = inStock ? 'in-stock' : 'out-of-stock';
        const stockText = inStock ? `In Stock (${product.stock})` : 'Out of Stock';
        
        return `
            <div class="medicine-card" data-id="${product.id}" data-category="${product.category}">
                <div class="medicine-info">
                    <h3>${product.name}</h3>
                    <p class="medicine-category">${product.category}</p>
                    <p class="medicine-description">${product.description}</p>
                    <div class="medicine-meta">
                        <p class="medicine-price">$${parseFloat(product.price).toFixed(2)}</p>
                        <p class="stock-status ${stockClass}">${stockText}</p>
                    </div>
                </div>
                <button class="add-to-cart-btn" ${!inStock ? 'disabled' : ''} data-id="${product.id}" data-name="${product.name}" data-price="${product.price}">
                    ${inStock ? 'Add to Cart' : 'Out of Stock'}
                </button>
            </div>
        `;
    }

    // Function to display products with pagination
    function displayProducts(products) {
        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const paginatedProducts = products.slice(startIndex, endIndex);
        
        const productGrid = document.getElementById('skincare-grid');
        const loadingIndicator = document.getElementById('loading');
        const noResults = document.getElementById('no-results');
        
        // Show loading indicator
        loadingIndicator.style.display = 'flex';
        productGrid.innerHTML = '';
        
        setTimeout(() => {
            loadingIndicator.style.display = 'none';
            
            if (paginatedProducts.length === 0) {
                noResults.style.display = 'flex';
                return;
            }
            
            noResults.style.display = 'none';
            
            paginatedProducts.forEach(product => {
                productGrid.innerHTML += createProductCard(product);
            });
            
            // Update pagination controls
            updatePagination(products.length);
            
            // Initialize add to cart buttons
            initAddToCartButtons();
        }, 500); // Simulate loading for 500ms for better UX
    }

    // Function to update pagination controls
    function updatePagination(totalProducts) {
        const totalPages = Math.ceil(totalProducts / productsPerPage);
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const currentPageSpan = document.getElementById('current-page');
        
        currentPageSpan.textContent = `Page ${currentPage} of ${totalPages}`;
        
        prevButton.disabled = currentPage === 1;
        nextButton.disabled = currentPage === totalPages || totalPages === 0;
    }

    // Function to filter products
    function filterProducts() {
        const searchTerm = document.getElementById('skincare-search').value.toLowerCase();
        const categoryFilter = document.getElementById('category-filter').value;
        const sortBy = document.getElementById('sort-by').value;
        const inStockOnly = document.getElementById('in-stock-only').checked;
        
        filteredProducts = currentProducts.filter(product => {
            // Apply search filter
            const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                               product.description.toLowerCase().includes(searchTerm);
            
            // Apply category filter
            const matchesCategory = categoryFilter === '' || product.category === categoryFilter;
            
            // Apply stock filter
            const matchesStock = !inStockOnly || (product.stock > 0);
            
            return matchesSearch && matchesCategory && matchesStock;
        });
        
        // Apply sorting
        sortProducts(sortBy);
        
        // Reset to first page when filters change
        currentPage = 1;
        
        // Display filtered products
        displayProducts(filteredProducts);
    }

    // Function to sort products
    function sortProducts(sortBy) {
        switch(sortBy) {
            case 'name-asc':
                filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
                break;
            case 'name-desc':
                filteredProducts.sort((a, b) => b.name.localeCompare(a.name));
                break;
            case 'price-asc':
                filteredProducts.sort((a, b) => a.price - b.price);
                break;
            case 'price-desc':
                filteredProducts.sort((a, b) => b.price - a.price);
                break;
        }
    }

    // Function to initialize add to cart buttons
    function initAddToCartButtons() {
        const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
        
        addToCartButtons.forEach(button => {
            if (!button.disabled) {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const productName = this.getAttribute('data-name');
                    const productPrice = parseFloat(this.getAttribute('data-price'));
                    
                    console.log(`Adding to cart: ${productName} ($${productPrice})`);
                    
                    // Add the item to cart using the Cart global object
                    try {
                        // Try to use the addToCart function from header-fix.js first
                        if (typeof addToCart === 'function') {
                            addToCart(productId, productName, productPrice, 1);
                            console.log('Added to cart using addToCart function');
                        }
                        // Fallback to ShoppingCart if available
                        else if (typeof ShoppingCart !== 'undefined') {
                            ShoppingCart.addItem({
                                id: productId,
                                name: productName,
                                price: productPrice,
                                quantity: 1
                            });
                            console.log('Added to cart using ShoppingCart');
                        } 
                        // Last resort - simple alert
                        else {
                            alert(`Added to cart: ${productName} - $${productPrice}`);
                            console.error('No cart implementation found');
                        }
                        
                        // Update UI
                        updateCartCount();
                        updateCartDisplay();
                    } catch (error) {
                        console.error('Error adding to cart:', error);
                        alert(`Added to cart: ${productName} - $${productPrice}`);
                    }
                });
            }
        });
    }

    // Function to update cart count
    function updateCartCount() {
        const cartCount = document.getElementById('cart-count');
        let count = 0;
        
        // Use the appropriate cart implementation based on your project
        if (typeof ShoppingCart !== 'undefined') {
            count = ShoppingCart.getTotalItems(); // This method exists and is correct
        } else if (typeof Cart !== 'undefined' && Cart.getItems) {
            count = Cart.getItems().length;
        }
        
        cartCount.textContent = count;
    }

    // Cart popup functionality
    function initCartPopup() {
        const cartButton = document.getElementById('cart-button');
        const cartPopup = document.getElementById('cart-popup');
        const closeCartButton = document.getElementById('close-cart');
        
        cartButton.addEventListener('click', function() {
            cartPopup.classList.add('active');
            updateCartDisplay();
        });
        
        closeCartButton.addEventListener('click', function() {
            cartPopup.classList.remove('active');
        });
        
        // Close when clicking outside
        document.addEventListener('click', function(e) {
            if (!cartPopup.contains(e.target) && e.target !== cartButton) {
                cartPopup.classList.remove('active');
            }
        });
    }

    // Function to update cart display in popup
    function updateCartDisplay() {
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalAmount = document.getElementById('cart-total-amount');
        let cartItems = [];
        let total = 0;
        
        // Get cart items from the appropriate cart implementation
        if (typeof ShoppingCart !== 'undefined') {
            cartItems = ShoppingCart.items; // Correct property access
            total = ShoppingCart.getTotalPrice(); // Correct method name
        } else if (typeof Cart !== 'undefined' && Cart.getItems) {
            cartItems = Cart.getItems();
            total = Cart.getTotal();
        }
        
        // Clear current items
        cartItemsContainer.innerHTML = '';
        
        if (cartItems.length === 0) {
            cartItemsContainer.innerHTML = '<p class="empty-cart">Your cart is empty</p>';
        } else {
            cartItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                cartItemsContainer.innerHTML += `
                    <div class="cart-item" data-id="${item.id}">
                        <div class="item-details">
                            <h4>${item.name}</h4>
                            <p>$${parseFloat(item.price).toFixed(2)} x ${item.quantity}</p>
                        </div>
                        <div class="item-total">$${itemTotal.toFixed(2)}</div>
                        <button class="remove-item" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    
                    if (typeof ShoppingCart !== 'undefined') {
                        ShoppingCart.removeItem(itemId); // This method exists and is correct
                    } else if (typeof Cart !== 'undefined' && Cart.removeItem) {
                        Cart.removeItem(itemId);
                    }
                    
                    updateCartCount();
                    updateCartDisplay();
                });
            });
        }
        
        cartTotalAmount.textContent = `$${total.toFixed(2)}`;
    }

    // Function to load products from API
    async function loadProducts() {
        try {
            const apiBaseUrl = typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : "http://127.0.0.1:5000";
            const skincareEndpoint = typeof API_ENDPOINTS !== 'undefined' ? API_ENDPOINTS.SKINCARE : `${apiBaseUrl}/api/skincare`;
            
            console.log('Attempting to fetch from:', skincareEndpoint);
            
            const response = await fetch(skincareEndpoint);
            if (!response.ok) {
                console.log('API endpoint failed, using sample data');
                currentProducts = sampleProducts;
                filteredProducts = [...currentProducts];
                displayProducts(filteredProducts);
                return;
            }
            
            const apiResponse = await response.json();
            console.log('API response:', apiResponse);
            
            // Try to extract products from various data structures
            let apiProducts = [];
            
            if (Array.isArray(apiResponse)) {
                apiProducts = apiResponse;
            } else if (apiResponse.success && Array.isArray(apiResponse.data)) {
                apiProducts = apiResponse.data;
            } else if (apiResponse.success && apiResponse.data && apiResponse.data.data && Array.isArray(apiResponse.data.data)) {
                apiProducts = apiResponse.data.data;
            } else if (apiResponse.success && apiResponse.data) {
                const possibleProducts = Object.values(apiResponse.data);
                const productsArray = possibleProducts.find(item => Array.isArray(item));
                if (productsArray) {
                    apiProducts = productsArray;
                }
            }
            
            if (apiProducts && apiProducts.length > 0) {
                // Ensure each product has a stock value for filtering
                apiProducts = apiProducts.map(product => ({
                    ...product,
                    stock: product.stock || Math.floor(Math.random() * 30) // Random stock if none provided
                }));
                
                currentProducts = apiProducts;
            } else {
                // Use sample data if API didn't return valid products
                currentProducts = sampleProducts;
            }
            
            filteredProducts = [...currentProducts];
            displayProducts(filteredProducts);
            
        } catch (error) {
            console.error("Error fetching from API, using sample data:", error);
            currentProducts = sampleProducts;
            filteredProducts = [...currentProducts];
            displayProducts(filteredProducts);
        }
    }

    // Initialize the ShoppingCart if it exists
    function initShoppingCart() {
        if (typeof ShoppingCart !== 'undefined' && typeof ShoppingCart.init === 'function') {
            console.log('Initializing ShoppingCart...');
            try {
                ShoppingCart.init();
                console.log('ShoppingCart initialized successfully');
            } catch (error) {
                console.error('Error initializing ShoppingCart:', error);
            }
        } else {
            console.log('ShoppingCart not available');
        }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize cart first
        initShoppingCart();
        // Set up pagination controls
        document.getElementById('prev-page').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                displayProducts(filteredProducts);
            }
        });
        
        document.getElementById('next-page').addEventListener('click', function() {
            const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayProducts(filteredProducts);
            }
        });
        
        // Set up filter event listeners
        document.getElementById('skincare-search').addEventListener('input', filterProducts);
        document.getElementById('category-filter').addEventListener('change', filterProducts);
        document.getElementById('sort-by').addEventListener('change', filterProducts);
        document.getElementById('in-stock-only').addEventListener('change', filterProducts);
        
        // Initialize cart popup
        initCartPopup();
        
        // Load initial products
        loadProducts();
        
        // Initialize header authentication with header-fix.js
        if (typeof updateAuthButtons === 'function') {
            updateAuthButtons();
        }
        
        // Log available cart functions for debugging
        console.log('Available cart functions:', {
            ShoppingCart: typeof ShoppingCart !== 'undefined',
            addToCart: typeof addToCart === 'function',
            Cart: typeof Cart !== 'undefined'
        });
    });
    </script>
    
    <!-- Add header.js to make auth buttons update -->
    <script type="module" src="../JS/header.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // CART POPUP TOGGLE
        const cartButton = document.getElementById('cart-button');
        const cartPopup = document.getElementById('cart-popup');
        const closeCart = document.getElementById('close-cart');
        const checkoutBtn = document.querySelector('.cart-popup .btn.btn-primary.btn-block');

        // Remove previous event listeners if any (defensive)
        cartButton.onclick = null;
        if (closeCart) closeCart.onclick = null;
        if (checkoutBtn) checkoutBtn.onclick = null;

        // Toggle cart popup
        cartButton.addEventListener('click', function(e) {
            e.stopPropagation();
            cartPopup.style.display = (cartPopup.style.display === 'block' ? 'none' : 'block');
        });
        // Close cart popup
        if (closeCart) {
            closeCart.addEventListener('click', function() {
                cartPopup.style.display = 'none';
            });
        }
        // Hide cart popup on outside click
        document.addEventListener('click', function(e) {
            if (!cartPopup.contains(e.target) && e.target !== cartButton) {
                cartPopup.style.display = 'none';
            }
        });
        // Checkout button
        if (checkoutBtn) {
            checkoutBtn.addEventListener('click', function() {
                window.location.href = 'checkout.html';
            });
        }

        // ENSURE ADD-TO-CART ALWAYS ADDS 1 ITEM
        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.onclick = null;
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const id = btn.dataset.id;
                const name = btn.dataset.name;
                const price = parseFloat(btn.dataset.price);
                const image = btn.dataset.image;
                if (typeof ShoppingCart !== 'undefined' && ShoppingCart.addItem) {
                    ShoppingCart.addItem({ id, name, price, image, quantity: 1 });
                }
            });
        });
    });
    </script>
</body>
</html>
